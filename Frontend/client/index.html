<!DOCTYPE html>
<html class="sl-theme-dark">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Content Recommendation System</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;1,300;1,400&family=Roboto:ital,wght@0,100;0,300;0,400;1,300&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.10.0/cdn/themes/dark.css"
    />

    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.10.0/cdn/shoelace-autoloader.js"
    ></script>
  </head>
  <body>
    <div id="page-container">
      <div id="header-main">Content Recommendation System</div>

      <sl-button id="openModal">Show Details</sl-button>
      <br />

      <div id="recommendation-container">
        <div id="recommendation-header">Recommendation System</div>
        <div id="system-content">
          <div id="recommendation-header">Current User</div>
          <div id="recommendation-user-score">
            <div id="current-user"></div>
            <div id="current-scores"></div>
          </div>
          <sl-button onclick="getTopPosts()" id="recc-button"
            >Get Recommended Posts</sl-button
          >
          <div id="recommendation-header">Recommended Posts</div>

          <div id="current-posts"></div>
        </div>
      </div>

      <div class="training-container">
        <div id="training-header">Training System</div>
        <div id="train-btn-container">
          <sl-button onclick="trainModel()">Train Model</sl-button>
        </div>
      </div>

      <div class="buttons">
        <sl-button id="connectButton" onclick="establishConnection()">
          Connect
        </sl-button>

        <sl-button id="sendButton" onclick="sendMessage()"
          >Send Message</sl-button
        >
        <sl-button id="closeButton" onclick="closeConnection()">
          Close Connection
        </sl-button>

        <div class="disconnected" id="connection-status-dot"></div>
      </div>

      <div id="entity-main-container">
        <div class="entity-selection">
          <sl-tab-group>
            <sl-tab slot="nav" panel="user"><span id="ent">Users</span></sl-tab>
            <sl-tab slot="nav" panel="post"><span id="ent">Posts</span></sl-tab>
            <sl-tab slot="nav" panel="product"
              ><span id="ent">Products</span></sl-tab
            >
            <sl-tab slot="nav" panel="interaction"
              ><span id="ent">Interactions</span></sl-tab
            >

            <sl-tab-panel name="user">
              <div class="entity-label">User</div>

              <div class="entity-input" id="user-input">
                <div class="entity-field-selection">
                  <label for="username">username</label>
                  <sl-input
                    type="text"
                    name="username"
                    placeholder="Enter User Name"
                    id="username"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="first_name">first_name</label>
                  <sl-input
                    type="text"
                    name="first_name"
                    placeholder="Enter first name"
                    id="first_name"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="last_name">last_name</label>
                  <sl-input
                    type="text"
                    name="last_name"
                    placeholder="Enter last name"
                    id="last_name"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="email">email</label>
                  <sl-input
                    type="text"
                    name="email"
                    placeholder="Enter email"
                    id="email"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="gender">gender</label>
                  <sl-input
                    type="text"
                    name="gender"
                    placeholder="M, F, NA"
                    id="gender"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="country">country</label>
                  <sl-input
                    type="text"
                    name="country"
                    placeholder="Enter country"
                    id="country"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="age">age</label>
                  <sl-input
                    type="number"
                    name="age"
                    placeholder="Enter age"
                    id="age"
                  />
                </div>
              </div>
            </sl-tab-panel>

            <sl-tab-panel name="interaction">
              <div class="entity-label">Interaction</div>

              <div class="entity-input" id="interaction-input">
                <div class="entity-field-selection">
                  <label for="interaction_type">interaction_type</label>
                  <sl-input
                    type="text"
                    name="interaction_type"
                    placeholder="Enter interaction type"
                    id="interaction_type"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="post_id">post_id</label>
                  <sl-input
                    type="text"
                    name="post_id"
                    placeholder="Enter post id"
                    id="post_id"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="username">username</label>
                  <sl-input
                    type="text"
                    name="username"
                    placeholder="Enter username"
                    id="username"
                  />
                </div>
              </div>
            </sl-tab-panel>

            <sl-tab-panel name="product">
              <div class="entity-label">Product</div>
              <div class="entity-input" id="product-input">
                <div class="entity-field-selection">
                  <label for="product_name">product_name</label>
                  <sl-input
                    type="text"
                    name="product_name"
                    placeholder="Enter product name"
                    id="product_name"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="category">category</label>
                  <sl-input
                    type="string"
                    name="category"
                    placeholder="Enter category"
                    id="category"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="pid">pid</label>
                  <sl-input
                    type="number"
                    name="pid"
                    placeholder="Enter product ID"
                    id="pid"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="url">url</label>
                  <sl-input
                    type="text"
                    name="url"
                    placeholder="Enter product URL"
                    id="url"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="manufacturers">manufacturers</label>
                  <sl-input
                    type="text"
                    name="manufacturers"
                    placeholder="Enter manufacturers"
                    id="manufacturers"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="last_accessed">last_accessed</label>
                  <sl-input
                    type="date"
                    name="last_accessed"
                    placeholder="Enter last accessed date"
                    id="last_accessed"
                  />
                </div>
              </div>
            </sl-tab-panel>

            <sl-tab-panel name="post">
              <div class="entity-label">Post</div>
              <div id="post-input" class="entity-input">
                <div class="entity-field-selection">
                  <label for="lang">lang</label>
                  <sl-input
                    type="text"
                    name="lang"
                    placeholder="Enter language"
                    id="lang"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="title">title</label>
                  <sl-input
                    type="text"
                    name="title"
                    placeholder="Enter Post Title"
                    id="title"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="short_title">short_title</label>
                  <sl-input
                    type="text"
                    name="short_title"
                    placeholder="Enter short title"
                    id="short_title"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="description">description</label>
                  <sl-input
                    type="text"
                    name="description"
                    placeholder="Enter description"
                    id="description"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="author">author</label>
                  <sl-input
                    type="text"
                    name="author"
                    placeholder="Enter author"
                    id="author"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="tags">tags</label>
                  <sl-input
                    type="text"
                    name="tags"
                    placeholder="Enter tags"
                    id="tags"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="post_id">post_id</label>
                  <sl-input
                    type="text"
                    name="post_id"
                    placeholder="Enter post id"
                    id="post_id"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="component">component</label>
                  <sl-input
                    type="text"
                    name="component"
                    placeholder="Enter component"
                    id="component"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="dynamic_path">dynamic_path</label>
                  <sl-input
                    type="text"
                    name="dynamic_path"
                    placeholder="Enter dynamic path"
                    id="dynamic_path"
                  />
                </div>
                <div class="entity-field-selection">
                  <label for="render_func">render_func</label>
                  <sl-input
                    type="text"
                    name="render_func"
                    placeholder="Enter render function"
                    id="render_func"
                  />
                </div>
              </div>
            </sl-tab-panel>
          </sl-tab-group>
        </div>

        <div id="json-display" class="entity-json-div">
          <pre><code id="json-code"></code></pre>
        </div>

        <div class="socket-status">
          <div>
            <sl-button id="send-button" onclick="sendEntity()">Send</sl-button>
          </div>
        </div>
      </div>

      <div id="myModal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <div id="content">
            <div class="subheader">Content Recommendation System</div>
            <div id="content-description">
              <div class="components">
                <ul>
                  <li>UI - Interacts with Backend</li>
                  <li>Elasticsearch Service - Distributed Cluster</li>
                  <li>ML Service - Vertically Scaling Server</li>
                  <li>Backend - Python Web Server</li>
                </ul>
              </div>
              <div>
                <span class="es">Elasticsearch Cluster</span> stores Data for
                Entities - <em class="it">Users, Posts , Interactions.</em>
              </div>
              <div>
                Events such as
                <em class="it">Page Visits , Views , Likes</em> are captured and
                sent to the Backend
              </div>
              <br />
              <div>
                These events go to the <strong>Backend</strong> - a
                <span class="py">Python Web Server</span> that asynchronously
                receives events and inserts them into the Elasticsearch Service.
              </div>
              <div>
                This Web Server is a
                <span class="hi">non-blocking multi-process</span> server that
                handles concurrent requests.
                <span class="es">Gunicorn</span> handles creating multiple
                processes/workers on a single thread.
                <span class="web">Uvicorn</span> and
                <span class="web">FastAPI</span> handle concurrent connections
                and requests on a single thread by using async programming.
              </div>
              <div>
                The <span class="es">Elasticsearch Service</span> provides
                utilities for Converting documents into Vector Embeddings using
                any model we prefer - I chose <span class="ml">SBERT</span> for
                this.
              </div>
              <br />

              <div>
                Between SBERT, BERT , and USE - BERT is a foundational model
                optimized for Classification Tasks. SBERT is optimized for
                Similarity tasks and lower latency - hence for a Real-Time
                recommendation System I chose it.
              </div>
              <br />

              <div>
                So events on the UI - are sent to the Web Server - which uses
                the ML Service to create Embeddings - and store them into
                Elasticsearch.
              </div>
              <div>
                We can then utilize these embeddings attached to every Document
                for a variety of tasks - like knn Search or Neural Network based
                Recommendation Systems.
              </div>
              <br />

              <div>
                In this system - we use the Vectors for a
                <span class="es">Content Recommendation System</span> - which is
                implemented using a
                <span class="es">Document Reranking algorithm.</span>
              </div>
              <div>
                Initial ranking is done using a
                <span class="ml">General Linear Model</span> - to determine
                relevant posts for a user using the various properties of Users
                and Posts.
              </div>
              <div>
                The <span class="ml">GLM Regression Model</span> might return to
                us a set of the top 100 posts based on the users' metadata - we
                then rerank these posts using the Vector Embeddings and serve
                the most relevant 10% of posts to the user.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        WebSocketClient,
        generateEntityHtml,
        createEntityFromInputs, // returns {entity:"User" , data : "userJsonObj"}
        mapEntityStrToClass,
        generateScoresCard,
        generateUserCard,
        generatePostCard,
        User,
        Post,
        Product,
        Interaction,
      } from "./bundle/index.js";

      /* DOM Functionality */

      var currentEntity = "user";

      const currentEntityState = document.querySelector("sl-tab-group");

      function updateJsonDisplay(entity) {
        const jsonStr = JSON.stringify(entity, null, 2);
        const codeElement = document.getElementById("json-code");
        if (codeElement) {
          codeElement.textContent = jsonStr;
        } else {
          console.error("Code element not found!");
        }
      }
      function clearInputs(inputContainerSelector) {
        const inputContainer = document.querySelector(inputContainerSelector);
        if (inputContainer) {
          const inputs = inputContainer.querySelectorAll("sl-input");
          inputs.forEach((input) => {
            input.value = "";
          });
        }
      }

      // Creates the Response to send through WS in shape {entity:"User" , data : "userJsonObj"}
      window.sendEntity = function sendEntityUsingWebSocket() {
        const { classConstructor, inputSelector } =
          mapEntityStrToClass(currentEntity);
        if (!classConstructor || !inputSelector) {
          console.error(`${currentEntity} is not a valid System Entity.`);
          return;
        }

        const entity = createEntityFromInputs(classConstructor, inputSelector);
        // Structuring the message with an action and entity
        const message = {
          action: "sendEntity",
          payload: entity,
        };
        console.log("Sending Entity Event:", message);

        client.sendMessage(JSON.stringify(message));

        clearInputs(inputSelector);
        updateJsonDisplay();
      };

      // Function to create entity from inputs and update JSON display
      function createAndDisplayEntity() {
        const { classConstructor, inputSelector } =
          mapEntityStrToClass(currentEntity);
        if (!classConstructor || !inputSelector) {
          console.error(`${classConstructor} is not a valid System Entity.`);
          return;
        }

        const entity = createEntityFromInputs(classConstructor, inputSelector);
        console.log(entity);
        updateJsonDisplay(entity);
      }

      // This function is triggered on input changes and also updates the JSON display
      function handleInputChange() {
        createAndDisplayEntity();
      }

      // Add event listeners to inputs for live updates
      function addLiveUpdateToInputs(inputContainerSelector) {
        const inputContainer = document.querySelector(inputContainerSelector);
        if (!inputContainer) {
          console.error(
            "No input container found with the selector:",
            inputContainerSelector
          );
          return;
        }

        const inputs = inputContainer.querySelectorAll("sl-input");
        if (inputs.length === 0) {
          console.error(
            "No inputs found in the container:",
            inputContainerSelector
          );
          return;
        }

        inputs.forEach((inputElement) => {
          inputElement.addEventListener("input", handleInputChange);
        });
      }

      currentEntityState.addEventListener("sl-tab-show", (event) => {
        currentEntity = event.detail.name;
        console.log("Current Entity Changed to ", currentEntity);

        const entityMapping = mapEntityStrToClass(currentEntity);
        if (!entityMapping || !entityMapping.inputSelector) {
          console.error(`${currentEntity} is not a valid System Entity.`);
          return;
        }

        addLiveUpdateToInputs(entityMapping.inputSelector);
        createAndDisplayEntity();
      });

      addLiveUpdateToInputs("#user-input");
      createAndDisplayEntity();

      window.createEntityFromInputs = createAndDisplayEntity;

      /* WebSocket Functionality */

      function updateConnectionStatus() {
        const isConnected = client.isConnected();

        if (isConnected) {
          connectionDot.style.backgroundColor = "green";
          connectionDot.classList.remove("disconnected"); // Remove the 'disconnected' class
          connectionDot.classList.add("connected"); // Add the 'connected' class
          console.log("Connection is active"); // Log connection active
        } else {
          connectionDot.style.backgroundColor = "red";
          connectionDot.classList.remove("connected"); // Remove the 'connected' class
          connectionDot.classList.add("disconnected"); // Add the 'disconnected' class
        }
      }

      var wsUrl = "ws://localhost:8000/ws";

      var client = new WebSocketClient(wsUrl);
      const connectionDot = document.getElementById("connection-status-dot");

      window.establishConnection = function () {
        client.establishConnection();
        setInterval(updateConnectionStatus, 1000); // check every second
      };

      window.sendMessage = function sendMessage() {
        client.sendMessage("Hello, server!");
      };

      window.closeConnection = function () {
        client.closeConnection();
      };

      var user = new User({
        username: "Fiero Martin",
        first_name: "Maroni",
        last_name: "Memes",
        email: "petriol.minam@aol.com",
        gender: "Female",
        country: "Italy",
        age: 24,
      });

      window.trainModel = function () {
        const message = {
          action: "trainModel",
        };

        console.log("Sending Train Model Action.");

        client.sendMessage(JSON.stringify(message));
      };

      // Call WS top users endpoint
      window.getTopPosts = function getTopPostsForUser() {
        const message = {
          action: "getTopPosts",
          payload: {
            entity: "User",
            data: user,
          },
        };

        console.log("Requesting top posts for user:", message);

        // Send the message to the server via websocket
        client.sendMessage(JSON.stringify(message));
      };

      function displayUserCardInBrowser(user) {
        const userCardHtml = generateUserCard(user);
        document.getElementById("current-user").innerHTML = userCardHtml;
      }

      displayUserCardInBrowser(user);

      function displayPostsInBrowser(posts) {
        let postsHtml = "";

        for (let post of posts) {
          postsHtml += generatePostCard(post);
        }

        document.getElementById("current-posts").innerHTML = postsHtml;
      }

      // Listen for Websockets event received by Server - and populate Posts
      document.addEventListener("topPostsReceived", function (e) {
        const postsData = e.detail;
        const posts = postsData.map((data) => new Post(data));
        displayPostsInBrowser(posts);
      });

      document.addEventListener("postScoresReceived", (event) => {
        const scores = event.detail;
        console.log("Received Scores:", scores);

        // Construct the HTML representation for scores
        const scoresCardHtml = generateScoresCard(scores);

        // Insert into the current-scores div
        const scoresContainer = document.getElementById("current-scores");
        scoresContainer.innerHTML = scoresCardHtml;
      });

      function displayCardInBrowser() {
        const userCardHtml = generateUserCard(/* User instance */);
        const postCardHtml = generatePostCard(/* Post instance */);

        // Assuming you have a container div in your HTML to hold these cards
        document.getElementById("cardsContainer").innerHTML += userCardHtml;
        document.getElementById("cardsContainer").innerHTML += postCardHtml;
      }
    </script>

    <script>
      var modal = document.getElementById("myModal");

      var btn = document.getElementById("openModal");

      var span = document.getElementsByClassName("close")[0];

      btn.onclick = function () {
        modal.style.display = "block";
      };

      span.onclick = function () {
        modal.style.display = "none";
      };

      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };
    </script>
  </body>
</html>
